# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Java CI with Maven

on:
  push:
    branches: [ "release-2.x" ]
#    branches: [ "main" ]
  pull_request:
    branches: [ "release-2.x" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest,ubuntu-22.04-arm, windows-latest, macos-latest,macos-13 ]
#            os: [ macos-latest ]
    #        os: [ubuntu-latest,ubuntu-22.04-arm, windows-latest, windows-11-arm,macos-latest,macos-13]
    name: build  ${{ matrix.os }}


    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Print JAVA_HOME
        run: echo "JAVA_HOME=$JAVA_HOME"

      - name: Install WiX Toolset via Chocolatey
        if: startsWith(matrix.os, 'windows')
        shell: cmd
        run: choco install -y innosetup wixtoolset

      - name: Check PATH and WiX/Inno Setup installation
        if: startsWith(matrix.os, 'windows')
        shell: powershell
        run: |
          Write-Host "Checking PATH..."
          echo $env:PATH
          
          Write-Host "Testing candle (WiX)..."
          try {
            Get-Command candle -ErrorAction Stop
            Write-Host "WiX Toolset is available."
          } catch {
            Write-Host "WiX Toolset NOT found in PATH!"
          }
          
          Write-Host "Testing iscc (Inno Setup)..."
          try {
            Get-Command iscc -ErrorAction Stop
            Write-Host "Inno Setup is available."
          } catch {
            Write-Host "Inno Setup NOT found in PATH!"
          }


      - name: Build with Maven
        run: mvn -B package -DskipTests --file pom.xml


        # æ–°å¢æ„å»ºäº§ç‰©æ”¶é›†æ­¥éª¤
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-${{ github.run_number }}
          path: |
            **/target/*.zip
            **/target/*.rpm
            **/target/*.dep
            **/target/*.gz
            **/target/*.msi
            **/target/*.exe
            **/target/*dependencies.jar
             **/target/*.dmg
          #          **/target/*.msm
          #          **/target/*.*
          if-no-files-found: error


    # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
#    - name: Update dependency graph
#      uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6




#è‡ªåŠ¨å‘å¸ƒ
  release-publish:
    env:
      RELEASE_TAG: v2.3.21
    runs-on: ubuntu-latest
    needs: build  # ä¾èµ–build jobå®Œæˆ
    if: github.ref == 'refs/heads/release-2.x'  # ä»…åœ¨releaseåˆ†æ”¯ä¸Šæ‰§è¡Œ
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Process and Rename Artifacts
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ./release-assets

          # è·å–ç‰ˆæœ¬å·ï¼Œå»é™¤å‰ç¼€'v'
          VERSION=${RELEASE_TAG#v}

          # å¯ç”¨é€’å½’globåŒ¹é…
          shopt -s globstar

          # éå†ä¸‹è½½çš„æ„ä»¶
          for artifact_dir in ./artifacts/*; do
            if [ -d "$artifact_dir" ]; then
              # è·å–ç›®å½•åå¹¶ç¡®å®šå¹³å°ç±»å‹
              dir_name=$(basename "$artifact_dir")

              # æ ¹æ®ç›®å½•åç¡®å®šå¹³å°æ ‡è¯†
              if [[ "$dir_name" == *"ubuntu"* ]]; then
                if [[ "$dir_name" == *"arm"* ]]; then
                  platform="linux-arm64"
                else
                  platform="linux-x86_64"
                fi
              elif [[ "$dir_name" == *"macos"* ]]; then
                if [[ "$dir_name" == *"latest"* ]] || [[ "$dir_name" == *"arm"* ]]; then
                  platform="macos-arm64"
                else
                  platform="macos-x86_64"
                fi
              elif [[ "$dir_name" == *"windows"* ]]; then
                platform="windows-x86_64"
              else
                platform="unknown"
              fi

              # è§£å‹æ„ä»¶
              unzip -q "$artifact_dir/*.zip" -d ./temp || true
              mkdir -p ./temp
              cp -r "$artifact_dir"/* ./temp/ || true
              echo "Files in temp directory:"
              file_count=0

              # ä½¿ç”¨globstaré€’å½’æŸ¥æ‰¾æ‰€æœ‰æ–‡ä»¶
              for file in ./temp/**; do
                if [ -f "$file" ]; then
                  file_count=$((file_count+1))
                  # è·å–æ–‡ä»¶æ‰©å±•å
                  extension="${file##*.}"
                  # å¦‚æœæ‰©å±•åæ˜¯ gzï¼Œåˆ™æ›¿æ¢ä¸º tar.gz
                  if [ "$extension" = "gz" ]; then
                    extension="tar.gz"
                  fi
          
                  # æ„é€ æ–°æ–‡ä»¶å
                  new_name="rdm-ui-$VERSION-$platform.$extension"
                  # ç§»åŠ¨å¹¶é‡å‘½åæ–‡ä»¶
                  mv "$file" "./release-assets/$new_name" || true
                  echo "Moved $file to ./release-assets/$new_name"
                fi
              done
              echo "Processed $file_count files for platform $platform"

              # æ¸…ç†ä¸´æ—¶ç›®å½•
              rm -rf ./temp
            fi
          done
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          release_name: ${{ env.RELEASE_TAG }}ğŸŒˆ
          draft: false
          prerelease: false

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ./release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ç¤ºä¾‹ï¼šåœ¨å‘å¸ƒReleaseæ—¶åŒæ—¶ä¸Šä¼ åˆ°Artifacts
      - name: Upload Release Assets to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets
          path: ./release-assets/*

#          å‘å¸ƒåˆ°mavenä¸­å¤®ä»“åº“
  publish-central:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Git Repo
        uses: actions/checkout@v4

      - name: Set up Apache Maven Central
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '21'
          server-id: central
          server-username: SERVER_USERNAME
          server-password: SERVER_PASSWORD
          gpg-private-key: ${{ secrets.GPG_SECRET }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Set zstd scope to runtime
        run: mvn versions:set-property -Dproperty=zstd.scope -DnewVersion=runtime

      - name: Publish to Apache Maven Central
        run: mvn deploy -DskipTests -P!linux-amd64,publish
        env:
          SERVER_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          SERVER_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSWORD }}
